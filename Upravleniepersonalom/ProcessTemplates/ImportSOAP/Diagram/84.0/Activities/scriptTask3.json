{
  "$type": "Comindware.Platform.Contracts.TaskActivityModel, Comindware.Platform.Contracts",
  "GlobalAlias": {
    "$type": "Comindware.Platform.Contracts.GlobalAlias, Comindware.Platform.Contracts",
    "Type": "Activity",
    "Owner": "ImportSOAP",
    "Alias": "scriptTask3"
  },
  "Kind": "Script",
  "ScriptDefinition": {
    "$type": "Comindware.Platform.Contracts.ScriptTaskDefinitionModel, Comindware.Platform.Contracts",
    "MaxExecutionTime": "03:00:00",
    "AttemptCount": 1,
    "AttemptInterval": "00:00:00",
    "Script": {
      "$type": "Comindware.Platform.Contracts.CustomRuleModel, Comindware.Platform.Contracts",
      "Type": "Custom",
      "Definition": {
        "$type": "Comindware.Platform.Contracts.CSharpRuleDefinitionModel, Comindware.Platform.Contracts",
        "Code": "using System; \nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Net;\nusing System.Text;\nusing System.Xml;\nusing System.Xml.Linq;\nusing System.Xml.Serialization;\n\nusing Comindware.Data.Entity;\nusing Comindware.TeamNetwork.Api.Data.UserCommands;\nusing Comindware.TeamNetwork.Api.Data;\n\n\npublic class Script\n{\n\tprivate const string COMMAND_PATTERN = @\"<?xml version=\"\"1.0\"\" encoding=\"\"utf-8\"\"?>\n    <soapenv:Envelope xmlns:soapenv=\"\"http://schemas.xmlsoap.org/soap/envelope/\"\" xmlns:dep=\"\"http://www.MFTI.ru/xml/departmets\"\">\n      <soapenv:Header/>\n   <soapenv:Body>\n      <dep:GetHeadsOfDepartment>\n         <dep:Date>{0}</dep:Date>\n         <dep:DepartmentID>{1}</dep:DepartmentID>\n      </dep:GetHeadsOfDepartment>\n   </soapenv:Body>\n</soapenv:Envelope>\";\n\n    private const string SOLUTION_NAME = \"Upravleniepersonalom\";\n\n    private const string SOAP_CONFIG_VAR = \"SOAP_CONFIG\";\n\n\tprivate const string SOAP_SERVICE = \"DEPARTMENT_HEADS\";\n    \n    private const string USER_ENTITY = \"Sotrudniki9\";\n\t\n\tpublic static void Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)\n\t{\n\t\tSoapConfig cfg = null;\n\t\tComindware.ImportSoapData inst = entities.ImportSoapData.First(item=>item.id == context.BusinessObjectId);\n        inst.DateTime = DateTime.Now;  \n        inst.ProcessId = context.ProcessId;\n\t\tinst.ServiceName = SOAP_SERVICE;\n        string command = string.Format(COMMAND_PATTERN, DateTime.Now.ToString(\"yyyy-MM-dd\"), \"\");\n        try\n        {\n\t\t\tstring soap_config_file = Api.Solution.SolutionVariableService.GetValue(SOLUTION_NAME, SOAP_CONFIG_VAR).ToString();\n            cfg = LoadConfig(soap_config_file, SOAP_SERVICE);\n            \n        \tvar doc = CallWebService (cfg, command);\n\t\t\tvar items = Parse(doc, cfg.XmlNamespace);\n\t\t\tinst.RecordAmount = items.Count();\n\t\t\tUpdate(cfg.ComindwareEntity, items);  \n\t\t\tinst.ErrorMessage += \"Success\";\n\t\t\tinst.Success = true;\t\t\t\n        }\n\t\tcatch (Exception exc)\n        {\n\t\t\tinst.Success = false;\n\t\t\tinst.ErrorCode = \"DEPARTMENT_HEADS_0006\";\n            string message = exc.ToString();\n\t\t\tif (cfg != null)\n\t\t\t\tmessage = cfg.ToString() + \"...\" + message;\n\t\t\tinst.ErrorMessage += message + \"...\" + command;\n        }\n\t\tentities.ImportSoapData.Edit(inst);\n\t}\n\t\n\tprivate static List<Employee> Parse(XDocument doc, string xNamespace)\n\t{\n\t\tvar employees = new List<Employee>();\n        XNamespace ns = xNamespace;\n\t\tvar xEmployees = doc.Descendants(ns + \"Employee\");\n\t\tforeach (XElement xEmployee in xEmployees)\n\t\t{\n\t\t\tvar employee = new Employee();\n            employee.Person = new PersonInformation();\n\t\t\tXElement xPerson = xEmployee.Element(ns + \"Person\");\n\t\t\temployee.Person.Name = xPerson.Element(ns + \"Name\").Value;\n\t\t\temployee.Person.CodeERFL = xPerson.Element(ns + \"CodeERFL\").Value;\n\t\t\temployee.Person.BirthDay = xPerson.Element(ns + \"BirthDay\").Value;\n\t\t\temployee.Name = xEmployee.Element(ns + \"Name\").Value;\n\t\t\temployee.Code = xEmployee.Element(ns + \"Code\").Value;\n\t\t\temployee.DepartmentID = xEmployee.Element(ns + \"DepartmentID\").Value;\n\t\t\temployee.Position = xEmployee.Element(ns + \"Position\").Value;\n\t\t\temployee.TypeOfEmployment = xEmployee.Element(ns + \"TypeOfEmployment\").Value;\n\t\t\temployee.DepartmentESO = xEmployee.Element(ns + \"DepartmentESO\").Value;\n\t\t\temployee.DepartmentName = xEmployee.Element(ns + \"DepartmentName\").Value;\n\t\t\temployees.Add(employee);\n\t\t}\n\t\treturn employees;\n\t}\n\t\n\tprivate static void Update(string entity, List<Employee> heads)\n\t{\n        \tvar users = Api.TeamNetwork.ObjectService.ListWithAlias (USER_ENTITY);\n            var userList = new List<string>();\n            var dublicates = new List<string>();\n            foreach (var item in users)\n            {\n                if (!item.ContainsKey(\"ERFL\"))\n                    continue;\n                string erfl = item[\"ERFL\"].ToString();\n                if (!string.IsNullOrEmpty(erfl) && userList.Contains(erfl))\n                {\n                    dublicates.Add(erfl);\n                }\n                else \n                {\n                    userList.Add(erfl);\n                }\n            }\n\t\t\tvar userDict = users\n                .Where(item=>\n                       item.ContainsKey(\"ERFL\") && \n                       item[\"ERFL\"] != null && \n                       !string.IsNullOrEmpty(item[\"ERFL\"].ToString()) && \n                       !dublicates.Contains(item[\"ERFL\"].ToString()))\n                .ToDictionary(item=>item[\"ERFL\"].ToString(), item=>item[\"id\"].ToString());\n\t\tforeach(var emp in heads)\n\t\t{\n            if (string.IsNullOrEmpty(emp.DepartmentESO))\n                continue;\n            var searchDictionary = new Dictionary<string,object>{{\"code\", emp.DepartmentESO}};\n\t\t\tvar recordData = Api.TeamNetwork.ObjectService.Get (entity, searchDictionary, new List<string> {\"id\"});\n\n\t\t\tvar record = new Dictionary<string, object>();\n\t\t\tFillHeadRecord(record, emp);\n            if (userDict.ContainsKey(emp.Person.CodeERFL))\n                record[\"Rukovoditel\"] = userDict[emp.Person.CodeERFL];\n\t\t\tif (recordData == null || recordData.Count() == 0)\n\t\t\t{\t\n                continue;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n                var recordId = recordData[\"id\"].ToString();\n\t\t\t\tApi.TeamNetwork.ObjectService.EditWithAlias(entity, recordId, record);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tprivate static void FillHeadRecord(Dictionary<string, object> dict, Employee emp)\n\t{\n\t\tdict[\"DepartmentId\"] = emp.DepartmentID;\n\t}\t\t\n\t\n\tprivate static XDocument CallWebService(SoapConfig cfg, string command)\n\t{\n        if (ServicePointManager.SecurityProtocol.HasFlag(SecurityProtocolType.Tls12) == false)\n        {\n            ServicePointManager.SecurityProtocol = ServicePointManager.SecurityProtocol | SecurityProtocolType.Tls12;\n        }\n\t\tHttpWebRequest webRequest = CreateWebRequest(cfg, command);\n\t\treturn LoadResult(webRequest);\n\t}\n    \n\tprivate static XDocument LoadResult(HttpWebRequest webRequest)\n\t{\n\t\tXDocument doc;\n        using (WebResponse webResponse = webRequest.GetResponse())\n        {\n            string soapResult;\n\t\t\tusing (StreamReader rd = new StreamReader(webResponse.GetResponseStream()))\n\t\t\t{\n\t\t\t\tsoapResult = rd.ReadToEnd();\n\t\t\t}\n\t\t\tdoc = XDocument.Parse(soapResult);\t\t\t      \n        }\n\t\treturn doc;\n\t}\n\t\n\tprivate static HttpWebRequest CreateWebRequest(SoapConfig cfg, string command)\n\t{\t\n\t\tHttpWebRequest webRequest = (HttpWebRequest)WebRequest.Create(cfg.SoapUrl);\n\t\twebRequest.Headers.Add(\"SOAPAction\", cfg.SoapAction);\n\t\twebRequest.Credentials = new NetworkCredential(cfg.Login, cfg.Password);\n\t\twebRequest.ContentType = \"text/xml;charset=\\\"utf-8\\\"\";\n\t\twebRequest.Accept = \"text/xml\";\n\t\twebRequest.Method = \"POST\";\n        if (!string.IsNullOrEmpty(cfg.SourceIpAddress))\n        {\n            webRequest.Proxy = null;\n       \t\twebRequest.ServicePoint.BindIPEndPointDelegate = delegate(ServicePoint servicePoint, IPEndPoint remoteEndPoint, int retryCount)\n\t\t\t{\n        \t\treturn new IPEndPoint(IPAddress.Parse(cfg.SourceIpAddress), 0);;\n        \t};\n        }\n\t\t\n\t\tEncoding enc = Encoding.UTF8;\n        byte[] bytes = enc.GetBytes(command);\n\t\twebRequest.ContentLength = bytes.Length;\n        using(Stream stream = webRequest.GetRequestStream())\n        {\n            stream.Write(bytes, 0, bytes.Length);\n        }\n\t\treturn webRequest;\n\t}\n\t\n\tprivate static SoapConfig LoadConfig(string link, string serviceName)\n    {\n        XmlSerializer formatter = new XmlSerializer(typeof(SoapConfig[]));\n        SoapConfig[] cfg;\n        using (FileStream fs = new FileStream(link, FileMode.Open))\n        {\n             cfg = (SoapConfig[])formatter.Deserialize(fs);\n        }\n        return cfg.FirstOrDefault(item => item.Name == serviceName);\n    }\n\t\n    [Serializable]\n\tpublic class SoapConfig\n\t{\n        [XmlAttribute]\n\t\tpublic string Name { get; set; }\n        [XmlAttribute]\n        public string SoapUrl { get; set; }\n\t\t[XmlAttribute]\n        public string SoapAction { get; set; }\n        [XmlElement]\n\t\tpublic string Login { get; set; }\n        [XmlElement]\n\t\tpublic string Password { get; set; }\n        [XmlAttribute]\n\t\tpublic string XmlNamespace { get; set; }\n        [XmlAttribute]\n\t\tpublic string ComindwareEntity { get; set; }\t\n\t\t[XmlAttribute]\n        public string SourceIpAddress { get; set; }\n\t\t\n\t\tpublic override string ToString()\n\t\t{\n\t\t\tStringBuilder sb = new StringBuilder();\n\t\t\tsb.AppendLine(string.Format(\"{0}.{1}\", \"Name\", Name));\n\t\t\tsb.AppendLine(string.Format(\"{0}.{1}\", \"SoapUrl\", SoapUrl));\n\t\t\tsb.AppendLine(string.Format(\"{0}.{1}\", \"SoapAction\", SoapAction));\n\t\t\tsb.AppendLine(string.Format(\"{0}.{1}\", \"XmlNamespace\", XmlNamespace));\n\t\t\tsb.AppendLine(string.Format(\"{0}.{1}\", \"ComindwareEntity\", ComindwareEntity));\n            sb.AppendLine(string.Format(\"{0}.{1}\", \"SourceIpAddress\", SourceIpAddress));\n\t\t\treturn sb.ToString();\n\t\t}\n\t}\n\t\n\tpublic class Employee\n\t{\n\t\tpublic PersonInformation Person { get; set; }\n\t\tpublic string Code { get; set; }\n\t\tpublic string Name { get; set; }\n\t\tpublic string DepartmentID { get; set; }\n\t\tpublic string Position { get; set; }\n\t\tpublic string TypeOfEmployment { get; set; }\n\t\tpublic string DepartmentESO { get; set; }\n\t\tpublic string DepartmentName { get; set; }\n\t}\n\t\n\tpublic class PersonInformation\n\t{\n\t\tpublic string Name { get; set; }\n\t\tpublic string CodeERFL { get; set; }\n\t\tpublic string BirthDay { get; set; }\n\t}\n}",
        "Type": "CSharpExpression"
      }
    }
  },
  "FormAlias": {
    "$type": "Comindware.Platform.Contracts.GlobalAlias, Comindware.Platform.Contracts",
    "Type": "ProcessForm",
    "Owner": "ImportSOAP"
  },
  "BehaviourState": "Undefined",
  "Title": "Загрузить руководителей подразделений",
  "IsTitleSet": false,
  "Position": {
    "$type": "Comindware.Platform.Contracts.VectorModel, Comindware.Platform.Contracts",
    "X": 920.0,
    "Y": 165.0
  },
  "Size": {
    "$type": "Comindware.Platform.Contracts.DimensionsModel, Comindware.Platform.Contracts",
    "Width": 120.0,
    "Height": 70.0
  },
  "Owner": {
    "$type": "Comindware.Platform.Contracts.GlobalAlias, Comindware.Platform.Contracts",
    "Type": "Activity",
    "Owner": "ImportSOAP",
    "Alias": "pool1"
  },
  "OwnerEmbeddedProcessActivityAlias": {
    "$type": "Comindware.Platform.Contracts.GlobalAlias, Comindware.Platform.Contracts",
    "Type": "Undefined"
  },
  "MountedOnAlias": {
    "$type": "Comindware.Platform.Contracts.GlobalAlias, Comindware.Platform.Contracts",
    "Type": "Undefined"
  },
  "Type": "Task"
}